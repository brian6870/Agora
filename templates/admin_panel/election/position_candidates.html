{% extends 'admin_panel/base_admin.html' %}
{% load static %}

{% block title %}Candidates for {{ position.name }} - {{ election.name }} - Agora{% endblock %}

{% block admin_content %}
<div class="max-w-7xl mx-auto space-y-8">
    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
            <div class="flex items-center space-x-3">
                <a href="{% url 'admin_panel:election_positions' election.id %}" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white">{{ position.name }}</h1>
            </div>
            <p class="text-gray-600 dark:text-gray-400 mt-2">{{ election.name }}</p>
        </div>
        <div class="flex space-x-3">
            <a href="{% url 'admin_panel:election_candidate_add' election.id position.id %}" 
               class="px-4 py-2 bg-gray-900 text-white dark:bg-white dark:text-gray-900 rounded-full text-sm font-medium hover:bg-gray-800 dark:hover:bg-gray-100 transition">
                <i class="fas fa-plus mr-2"></i>Add Candidate
            </a>
            <a href="{% url 'admin_panel:candidate_applications' %}?position={{ position.id }}" 
               class="px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-full text-sm font-medium hover:bg-gray-100 dark:hover:bg-gray-800 transition">
                <i class="fas fa-users mr-2"></i>View Applications
                {% if pending_applications > 0 %}
                <span class="ml-2 px-2 py-0.5 bg-red-500 text-white rounded-full text-xs">{{ pending_applications }}</span>
                {% endif %}
            </a>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <div class="glass-card p-6">
            <p class="text-sm text-gray-500 dark:text-gray-400">Total Candidates</p>
            <p class="text-3xl font-bold text-gray-900 dark:text-white">{{ candidates.count }}</p>
        </div>
        <div class="glass-card p-6">
            <p class="text-sm text-gray-500 dark:text-gray-400">Active Candidates</p>
            <p class="text-3xl font-bold text-green-600">{{ active_count }}</p>
        </div>
        <div class="glass-card p-6">
            <p class="text-sm text-gray-500 dark:text-gray-400">From Applications</p>
            <p class="text-3xl font-bold text-blue-600">{{ from_applications }}</p>
        </div>
        <div class="glass-card p-6">
            <p class="text-sm text-gray-500 dark:text-gray-400">Manually Added</p>
            <p class="text-3xl font-bold text-purple-600">{{ manually_added }}</p>
        </div>
    </div>

    <!-- Candidates List -->
    <div class="glass-card p-6">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Candidates</h2>
            {% if candidates|length > 1 %}
            <button onclick="saveOrder()" class="px-4 py-2 bg-gray-900 text-white dark:bg-white dark:text-gray-900 rounded-full text-sm font-medium hover:bg-gray-800 dark:hover:bg-gray-100 transition">
                <i class="fas fa-save mr-2"></i>Save Order
            </button>
            {% endif %}
        </div>

        <div id="candidatesList" class="space-y-4">
            {% for candidate in candidates %}
            <div class="candidate-item flex items-center p-4 bg-gray-50 dark:bg-gray-800 rounded-xl cursor-move hover:bg-gray-100 dark:hover:bg-gray-700 transition-all"
                 data-id="{{ candidate.id }}"
                 data-order="{{ candidate.order }}">
                <!-- Drag Handle -->
                <div class="drag-handle mr-4 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                    <i class="fas fa-grip-vertical"></i>
                </div>
                
                <!-- Candidate Photo -->
                <div class="w-12 h-12 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center mr-4 flex-shrink-0">
                    {% if candidate.photo %}
                    <img src="{{ candidate.photo.url }}" alt="{{ candidate.full_name }}" class="w-full h-full rounded-full object-cover">
                    {% else %}
                    <i class="fas fa-user text-gray-500 dark:text-gray-400"></i>
                    {% endif %}
                </div>
                
                <!-- Candidate Info -->
                <div class="flex-1">
                    <div class="flex items-center">
                        <span class="text-sm font-medium text-gray-500 dark:text-gray-400 mr-3">#{{ candidate.order }}</span>
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">{{ candidate.full_name }}</h3>
                        {% if candidate.team %}
                        <span class="ml-3 px-3 py-1 rounded-full text-xs font-medium" style="background-color: {{ candidate.team.color_code }}20; color: {{ candidate.team.color_code }}">
                            {{ candidate.team.name }}
                        </span>
                        {% endif %}
                        {% if not candidate.is_active %}
                        <span class="ml-3 px-2 py-1 bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-400 rounded-full text-xs">Inactive</span>
                        {% endif %}
                        {% if candidate.application %}
                        <span class="ml-3 px-2 py-1 bg-blue-100 text-blue-700 dark:bg-blue-900/20 dark:text-blue-400 rounded-full text-xs">Applied</span>
                        {% endif %}
                    </div>
                    
                    <!-- Candidate Details -->
                    <div class="flex items-center mt-2 space-x-4 text-xs text-gray-500">
                        <span><i class="fas fa-vote-yea mr-1"></i>{{ candidate.vote_count }} votes</span>
                        {% if candidate.bio %}
                        <span><i class="fas fa-info-circle mr-1"></i>Has bio</span>
                        {% endif %}
                        {% if candidate.manifesto %}
                        <span><i class="fas fa-file-alt mr-1"></i>Has manifesto</span>
                        {% endif %}
                        {% if candidate.voter %}
                        <span><i class="fas fa-user-check mr-1"></i>Registered voter</span>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex items-center space-x-2 ml-4">
                    <a href="{% url 'admin_panel:election_candidate_edit' election.id position.id candidate.id %}" 
                       class="p-2 text-gray-600 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white transition"
                       title="Edit">
                        <i class="fas fa-edit"></i>
                    </a>
                    <button onclick="toggleActive({{ candidate.id }})" 
                            class="p-2 text-gray-600 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white transition"
                            title="{% if candidate.is_active %}Deactivate{% else %}Activate{% endif %}">
                        <i class="fas {% if candidate.is_active %}fa-eye-slash{% else %}fa-eye{% endif %}"></i>
                    </button>
                    <button onclick="deleteCandidate({{ candidate.id }})" 
                            class="p-2 text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 transition"
                            title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            {% empty %}
            <div class="text-center py-12">
                <i class="fas fa-user-tie fa-4x text-gray-400 mb-4"></i>
                <h3 class="text-xl font-medium text-gray-900 dark:text-white mb-2">No Candidates Yet</h3>
                <p class="text-gray-600 dark:text-gray-400 mb-6">Add candidates manually or approve applications.</p>
                <div class="flex justify-center space-x-4">
                    <a href="{% url 'admin_panel:election_candidate_add' election.id position.id %}" 
                       class="px-6 py-3 bg-gray-900 text-white dark:bg-white dark:text-gray-900 rounded-full text-sm font-medium hover:bg-gray-800 dark:hover:bg-gray-100 transition">
                        <i class="fas fa-plus mr-2"></i>
                        Add Manually
                    </a>
                    <a href="{% url 'admin_panel:candidate_applications' %}?position={{ position.id }}" 
                       class="px-6 py-3 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-full text-sm font-medium hover:bg-gray-100 dark:hover:bg-gray-800 transition">
                        <i class="fas fa-users mr-2"></i>
                        Review Applications
                        {% if pending_applications > 0 %}
                        <span class="ml-2 px-2 py-0.5 bg-red-500 text-white rounded-full text-xs">{{ pending_applications }}</span>
                        {% endif %}
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Team Distribution -->
        <div class="glass-card p-6">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Team Distribution</h3>
            <div class="space-y-3">
                {% for team in team_stats %}
                <div>
                    <div class="flex justify-between text-sm mb-1">
                        <span class="text-gray-600 dark:text-gray-400">{{ team.name }}</span>
                        <span class="font-medium text-gray-900 dark:text-white">{{ team.count }}</span>
                    </div>
                    <div class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                        <div class="h-full bg-gray-900 dark:bg-white rounded-full" style="width: {% widthratio team.count candidates.count 100 %}%"></div>
                    </div>
                </div>
                {% empty %}
                <p class="text-sm text-gray-500 text-center">No teams assigned</p>
                {% endfor %}
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="glass-card p-6">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Quick Stats</h3>
            <div class="space-y-4">
                <div>
                    <p class="text-xs text-gray-500">Independent Candidates</p>
                    <p class="text-xl font-bold text-gray-900 dark:text-white">{{ independent_count }}</p>
                </div>
                <div>
                    <p class="text-xs text-gray-500">With Manifesto</p>
                    <p class="text-xl font-bold text-gray-900 dark:text-white">{{ with_manifesto }}</p>
                </div>
                <div>
                    <p class="text-xs text-gray-500">With Photo</p>
                    <p class="text-xl font-bold text-gray-900 dark:text-white">{{ with_photo }}</p>
                </div>
            </div>
        </div>

        <!-- Ballot Preview -->
        <div class="glass-card p-6">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Ballot Preview</h3>
            <div class="space-y-2">
                {% for candidate in candidates|slice:":3" %}
                <div class="flex items-center p-2 bg-gray-50 dark:bg-gray-800 rounded-lg">
                    <div class="w-2 h-2 rounded-full bg-gray-400 mr-2"></div>
                    <span class="text-sm text-gray-700 dark:text-gray-300">{{ candidate.full_name }}</span>
                    {% if candidate.team %}
                    <span class="ml-auto text-xs text-gray-500">{{ candidate.team.acronym }}</span>
                    {% endif %}
                </div>
                {% endfor %}
                {% if candidates|length > 3 %}
                <p class="text-xs text-gray-500 text-center">+{{ candidates|length|add:"-3" }} more</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Include SortableJS -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

<script>
let sortable;

document.addEventListener('DOMContentLoaded', function() {
    const list = document.getElementById('candidatesList');
    if (list && list.children.length > 1) {
        sortable = new Sortable(list, {
            animation: 150,
            handle: '.drag-handle',
            ghostClass: 'opacity-50',
            onEnd: function() {
                updateOrderNumbers();
            }
        });
    }
});

function updateOrderNumbers() {
    const items = document.querySelectorAll('.candidate-item');
    items.forEach((item, index) => {
        const orderSpan = item.querySelector('.text-sm.font-medium.text-gray-500');
        if (orderSpan) {
            orderSpan.textContent = `#${index + 1}`;
        }
    });
}

function saveOrder() {
    const items = document.querySelectorAll('.candidate-item');
    const orderData = [];
    
    items.forEach((item, index) => {
        orderData.push({
            id: item.dataset.id,
            order: index + 1
        });
    });
    
    fetch('{% url "admin_panel:election_candidates_reorder" election.id position.id %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ order: orderData })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Candidate order saved successfully');
        } else {
            alert('Error saving order');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Network error. Please try again.');
    });
}

function toggleActive(candidateId) {
    fetch(`/admin-panel/elections/{{ election.id }}/positions/{{ position.id }}/candidates/${candidateId}/toggle-active/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        }
    });
}

function deleteCandidate(candidateId) {
    if (confirm('Are you sure you want to delete this candidate?')) {
        fetch(`/admin-panel/elections/{{ election.id }}/positions/{{ position.id }}/candidates/${candidateId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        });
    }
}
</script>
{% endblock %}
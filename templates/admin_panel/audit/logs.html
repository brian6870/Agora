{% extends 'admin_panel/base_admin.html' %}
{% load static %}

{% block title %}Audit Logs - Agora{% endblock %}

{% block admin_content %}
<div class="max-w-7xl mx-auto">
    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Audit Logs</h1>
            <p class="text-gray-600 dark:text-gray-400 mt-2">View system activity and audit trail</p>
        </div>
        <div class="flex space-x-3">
            <!-- FIXED: Using export_report with 'audit' as report type -->
            <a href="{% url 'admin_panel:export_report' 'audit' %}?{{ request.GET.urlencode }}" class="px-4 py-2 bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-300 rounded-full text-sm font-medium hover:bg-gray-300 dark:hover:bg-gray-600 transition">
                <i class="fas fa-download mr-2"></i>Export
            </a>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="glass-card p-4">
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-1">Total Events</p>
            <p class="text-2xl font-bold text-gray-900 dark:text-white">{{ total_events }}</p>
        </div>
        <div class="glass-card p-4">
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-1">Today</p>
            <p class="text-2xl font-bold text-gray-900 dark:text-white">{{ today_events }}</p>
        </div>
        <div class="glass-card p-4">
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-1">This Week</p>
            <p class="text-2xl font-bold text-gray-900 dark:text-white">{{ week_events }}</p>
        </div>
        <div class="glass-card p-4">
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-1">Unique Users</p>
            <p class="text-2xl font-bold text-gray-900 dark:text-white">{{ unique_users }}</p>
        </div>
    </div>

    <!-- Filters -->
    <div class="glass-card p-6 mb-8">
        <form method="get" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Date From</label>
                    <input type="date" name="date_from" value="{{ request.GET.date_from }}" class="form-input w-full">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Date To</label>
                    <input type="date" name="date_to" value="{{ request.GET.date_to }}" class="form-input w-full">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">User</label>
                    <input type="text" name="user" value="{{ request.GET.user }}" class="form-input w-full" placeholder="Search user...">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Category</label>
                    <select name="category" class="form-select w-full">
                        <option value="">All Categories</option>
                        {% for key, value in categories %}
                        <option value="{{ key }}" {% if request.GET.category == key %}selected{% endif %}>{{ value }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="flex justify-end space-x-3">
                <a href="{% url 'admin_panel:audit_logs' %}" class="px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-full text-sm font-medium hover:bg-gray-100 dark:hover:bg-gray-800 transition">
                    Clear
                </a>
                <button type="submit" class="px-4 py-2 bg-gray-900 text-white dark:bg-white dark:text-gray-900 rounded-full text-sm font-medium hover:bg-gray-800 dark:hover:bg-gray-100 transition">
                    Apply Filters
                </button>
            </div>
        </form>
    </div>

    <!-- Audit Logs Table -->
    <div class="glass-card overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="border-b border-white/30 dark:border-white/10 bg-gray-50/50 dark:bg-gray-800/50">
                        <th class="text-left py-4 px-6 text-sm font-medium text-gray-500 dark:text-gray-400">Timestamp</th>
                        <th class="text-left py-4 px-6 text-sm font-medium text-gray-500 dark:text-gray-400">User</th>
                        <th class="text-left py-4 px-6 text-sm font-medium text-gray-500 dark:text-gray-400">Action</th>
                        <th class="text-left py-4 px-6 text-sm font-medium text-gray-500 dark:text-gray-400">Category</th>
                        <th class="text-left py-4 px-6 text-sm font-medium text-gray-500 dark:text-gray-400">IP Address</th>
                        <th class="text-left py-4 px-6 text-sm font-medium text-gray-500 dark:text-gray-400">Details</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in logs %}
                    <tr class="border-b border-white/10 dark:border-white/5 hover:bg-white/5 transition-colors">
                        <td class="py-4 px-6 text-sm text-gray-600 dark:text-gray-400">{{ log.timestamp|date:"Y-m-d H:i:s" }}</td>
                        <td class="py-4 px-6">
                            <div class="flex items-center">
                                <div class="w-8 h-8 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center mr-3">
                                    <i class="fas fa-user text-xs text-gray-500 dark:text-gray-400"></i>
                                </div>
                                <span class="text-sm font-medium text-gray-900 dark:text-white">{{ log.user.full_name|default:'System' }}</span>
                            </div>
                        </td>
                        <td class="py-4 px-6 text-sm text-gray-600 dark:text-gray-400">{{ log.action }}</td>
                        <td class="py-4 px-6">
                            <span class="px-3 py-1 rounded-full text-xs font-medium
                                {% if log.category == 'SECURITY' %}bg-red-100 text-red-700 dark:bg-red-900/20 dark:text-red-400
                                {% elif log.category == 'ADMIN' %}bg-blue-100 text-blue-700 dark:bg-blue-900/20 dark:text-blue-400
                                {% elif log.category == 'VOTER' %}bg-green-100 text-green-700 dark:bg-green-900/20 dark:text-green-400
                                {% elif log.category == 'ELECTION' %}bg-purple-100 text-purple-700 dark:bg-purple-900/20 dark:text-purple-400
                                {% else %}bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-400{% endif %}">
                                {{ log.get_category_display }}
                            </span>
                        </td>
                        <td class="py-4 px-6 text-sm text-gray-600 dark:text-gray-400">{{ log.ip_address }}</td>
                        <td class="py-4 px-6">
                            <button onclick="viewLogDetails({{ log.id }})" 
                                    class="text-gray-600 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white"
                                    title="View Details">
                                <i class="fas fa-info-circle"></i>
                            </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="py-12 text-center text-gray-500 dark:text-gray-400">
                            <i class="fas fa-history fa-4x mb-4 opacity-50"></i>
                            <p class="text-lg">No audit logs found</p>
                            <p class="text-sm mt-2">Try adjusting your filters</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if is_paginated %}
        <div class="flex items-center justify-between px-6 py-4 border-t border-white/30 dark:border-white/10">
            <p class="text-sm text-gray-500 dark:text-gray-400">
                Showing page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
            </p>
            <div class="flex space-x-2">
                {% if page_obj.has_previous %}
                <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.date_from %}&date_from={{ request.GET.date_from }}{% endif %}{% if request.GET.date_to %}&date_to={{ request.GET.date_to }}{% endif %}{% if request.GET.user %}&user={{ request.GET.user }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}" 
                   class="w-10 h-10 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center hover:bg-gray-200 dark:hover:bg-gray-700 transition-all group">
                    <i class="fas fa-chevron-left text-gray-600 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white"></i>
                </a>
                {% endif %}
                
                <span class="w-10 h-10 rounded-full bg-gray-900 text-white dark:bg-white dark:text-gray-900 flex items-center justify-center text-sm font-medium">
                    {{ page_obj.number }}
                </span>
                
                {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}{% if request.GET.date_from %}&date_from={{ request.GET.date_from }}{% endif %}{% if request.GET.date_to %}&date_to={{ request.GET.date_to }}{% endif %}{% if request.GET.user %}&user={{ request.GET.user }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}" 
                   class="w-10 h-10 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center hover:bg-gray-200 dark:hover:bg-gray-700 transition-all group">
                    <i class="fas fa-chevron-right text-gray-600 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white"></i>
                </a>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Log Details Modal -->
<div id="logDetailsModal" class="fixed inset-0 z-[9999] hidden">
    <div class="fixed inset-0 bg-black/70 backdrop-blur-sm" onclick="closeLogDetailsModal()"></div>
    <div class="fixed inset-0 flex items-center justify-center p-4">
        <div class="glass-card p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-900 dark:text-white">Log Details</h3>
                <button onclick="closeLogDetailsModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="logDetailsContent" class="space-y-4">
                <!-- Content loaded dynamically -->
                <div class="flex justify-center py-8">
                    <div class="w-10 h-10 border-4 border-gray-300 border-t-gray-900 rounded-full animate-spin"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.hero-text {
    text-shadow: 0 2px 10px rgba(0,0,0,0.1);
    transform: perspective(1000px) rotateX(0deg);
    transition: transform 0.3s ease;
}
.hero-text:hover {
    transform: perspective(1000px) rotateX(2deg) translateZ(20px) scale(1.05);
}

/* Table hover effects */
tbody tr:hover td {
    background-color: rgba(0,0,0,0.02);
}

.dark tbody tr:hover td {
    background-color: rgba(255,255,255,0.02);
}
</style>

<script>
function viewLogDetails(logId) {
    const modal = document.getElementById('logDetailsModal');
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    
    // Fetch log details
    fetch(`/admin-panel/audit-logs/${logId}/`)
        .then(response => response.json())
        .then(data => {
            const content = document.getElementById('logDetailsContent');
            content.innerHTML = `
                <div class="space-y-4">
                    <div class="p-4 bg-gray-50 dark:bg-gray-800 rounded-xl">
                        <p class="text-xs text-gray-500 mb-1">Timestamp</p>
                        <p class="text-sm font-medium">${new Date(data.timestamp).toLocaleString()}</p>
                    </div>
                    
                    <div class="p-4 bg-gray-50 dark:bg-gray-800 rounded-xl">
                        <p class="text-xs text-gray-500 mb-1">User</p>
                        <p class="text-sm font-medium">${data.user || 'System'}</p>
                    </div>
                    
                    <div class="p-4 bg-gray-50 dark:bg-gray-800 rounded-xl">
                        <p class="text-xs text-gray-500 mb-1">Action</p>
                        <p class="text-sm font-medium">${data.action}</p>
                    </div>
                    
                    <div class="p-4 bg-gray-50 dark:bg-gray-800 rounded-xl">
                        <p class="text-xs text-gray-500 mb-1">Category</p>
                        <p class="text-sm font-medium">${data.category}</p>
                    </div>
                    
                    <div class="p-4 bg-gray-50 dark:bg-gray-800 rounded-xl">
                        <p class="text-xs text-gray-500 mb-1">IP Address</p>
                        <p class="text-sm font-medium">${data.ip_address || 'N/A'}</p>
                    </div>
                    
                    <div class="p-4 bg-gray-50 dark:bg-gray-800 rounded-xl">
                        <p class="text-xs text-gray-500 mb-1">User Agent</p>
                        <p class="text-sm font-medium break-all">${data.user_agent || 'N/A'}</p>
                    </div>
                    
                    <div class="p-4 bg-gray-50 dark:bg-gray-800 rounded-xl">
                        <p class="text-xs text-gray-500 mb-1">Details</p>
                        <pre class="text-sm font-mono bg-white dark:bg-gray-900 p-3 rounded-lg overflow-x-auto">${JSON.stringify(data.details, null, 2)}</pre>
                    </div>
                </div>
            `;
        })
        .catch(error => {
            document.getElementById('logDetailsContent').innerHTML = `
                <div class="text-center py-8 text-red-600">
                    <i class="fas fa-exclamation-circle text-4xl mb-3"></i>
                    <p>Error loading log details</p>
                </div>
            `;
        });
}

function closeLogDetailsModal() {
    document.getElementById('logDetailsModal').classList.add('hidden');
    document.body.style.overflow = 'auto';
}

// Close modal on escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeLogDetailsModal();
    }
});
</script>
{% endblock %}